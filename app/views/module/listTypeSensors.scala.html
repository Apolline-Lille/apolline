@(sort:String,modele:String,listType:List[TypeSensor],listMesure:List[TypeMesure],espece:List[Espece],stock:List[reactivemongo.bson.BSONDocument],stockUsed:List[(reactivemongo.bson.BSONObjectID,Int)],filtre:List[reactivemongo.bson.BSONDocument])(implicit request: Request[AnyContent])

@import reactivemongo.bson.BSONObjectID

@main(Messages("inventary.module.title")){
  @navigation("inventary")
  <div class="container">
    @inventary("module")
    <section>
      @module.stateForm("sensors")
      <article class="col-sm-9">
        <div>
        @if(listType.size==0){
          <h3 style="text-align:center">@Messages("global.error.noResult")</h3>
        }else {
          @for(types <- listType) {
            @defining(stock.filter(p=>p.getAs[BSONObjectID]("_id").get.equals(types._id))){s=>
              @defining(if(s.nonEmpty){
                s.head.getAs[reactivemongo.bson.BSONInteger]("count").get.value
              }else{
                0
              }) { sto =>
                @defining(sto - stockUsed.filter(p=>p._1.equals(types._id)).head._2) { stoUnused =>
                  <div class="col-sm-12">
                    <h4><a href="@routes.ModuleManager.formTypeSensors(types.nomType)">@{
                      types.nomType
                    }</a> / <a href="@routes.ModuleManager.formSensors(types._id.stringify)">@{
                      types.modele
                    }</a>
                    </h4>
                  </div>
                  <div class="col-sm-11 col-sm-offset-1">
                    <div class="row"> <span class="bold">@Messages("inventary.typeSensor.fabricant")</span> : @{
                      types.fabricant
                    } </div>
                    <div class="row"> <span class="bold">@Messages("inventary.typeSensor.nbSignaux")</span> : @{
                      types.nbSignaux
                    }</div>
                    <div class="row">
                      <span class="bold">@Messages("inventary.typeSensor.espece")</span> :
                      <div class="col-sm-10 col-sm-offset-1 table-responsive">
                        <table class="table table-hover table-bordered">
                          <thead>
                            <tr>
                              <th>@Messages("inventary.typeSensor.nomEspece")</th>
                              <th>@Messages("inventary.typeSensor.mesure")</th>
                              <th>@Messages("inventary.typeSensor.signalMin")</th>
                              <th>@Messages("inventary.typeSensor.signalMax")</th>
                            </tr>
                          </thead>
                          <tbody>
                          @for(esp <- types.espece) {
                            @defining(espece.find(p => p._id.equals(esp))) {currentEsp=>
                              @if(currentEsp.nonEmpty){
                                @defining(listMesure.find(p=>p._id.equals(currentEsp.get.mesure))){mesure=>
                                  @if(mesure.nonEmpty){
                                    <tr>
                                      <td>@currentEsp.get.espece</td>
                                      <td>@mesure.get.nom</td>
                                      <td>@currentEsp.get.min @mesure.get.unite</td>
                                      <td>@currentEsp.get.max @mesure.get.unite</td>
                                    </tr>
                                  }
                                }
                              }
                            }
                          }
                          </tbody>
                        </table>
                      </div>
                    </div>
                    <div class="row"> <span class="bold">@Messages("inventary.typeSensor.stock")</span> : @stoUnused / @sto</div>
                  </div>
                }
              }
            }
          }
        }
        </div>
        <p>
          <span style="float:right">
            <a href="@routes.ModuleManager.validate()" class="btn btn-default">@Messages("inventary.module.nextState")</a>
          </span>
        </p>
      </article>
      <nav class="col-sm-3">
        @if(filtre.size>1) {
          <span class="bold">@Messages("inventary.typeSensor.type")</span>
          <ul class="nav nav-pills nav-stacked">
            <li role="presentation" @if(sort.isEmpty) {
              class="active"}><a href="@routes.ModuleManager.formTypeSensors("",modele)" style="padding:0px 15px !important">
            @Messages("global.all")</a></li>
            @for(types <- filtre) {
              @defining(types.getAs[String]("_id").get) { nomType =>
                <li role="presentation" @if(sort.equals(nomType)) {
                  class="active"}><a href="@routes.ModuleManager.formTypeSensors(nomType,modele)" style="padding:0px 15px !important">@nomType</a></li>
              }
            }
          </ul>
        }
        <div class="search_lateral">
        @helper.form(action=routes.ModuleManager.formTypeSensors()){
          <div class="input-group">
            <div class="input-group-addon"><span class="glyphicon glyphicon-search"></span></div>
            <input type="search" name="modele" class="form-control" value="@modele" placeholder="@Messages("inventary.typeSensor.model")"/>
            <input type="hidden" name="types" value="@sort"/>
          </div>
        }
        </div>
      </nav>
    </section>
  </div>
}